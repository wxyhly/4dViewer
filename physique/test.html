<html>
<script src="../math.js"></script>
<script src="../shape.js"></script>
<script src="../webgl.js"></script>
<script src="../renderer.js"></script>
<script src="../controler.js"></script>
<script src="../polychora.js"></script>
<script src="../lib/dat.gui.min.js"></script>
<script src="phy4d.js"></script>
<script>
'use strict';
var gl$ = function (obj){
	return document.getElementById(obj).getContext("experimental-webgl");
}
var diceP,physicsEngine,addGlome;
function start(){
	var scene = new Scene();
	var glomes = [];
	var planeWidth = 15;
	//ground
	var groundM = Mesh3.cube(planeWidth).embed(true,new Vec4(1,0,0,0),new Vec4(0,0,1,0),new Vec4(0,0,0,1));
	scene.add(new Geom4(groundM,null,null,0xFFFFAA));
	//wall
	var wall = groundM.clone();
	wall.C.pop();
	wall = wall.extrude(new Vec4(0,planeWidth,0,0));
	scene.add(new Geom4(wall,null,null,0xEEEEEE));
	
	
	var diceM2 = Mesh4.tesseract(2);//.rotate(new Bivec(Math.PI/4));
	
	//Mesh4.cuboid(0.5,2,0.5,0.5);
	
	//var diceM = Mesh4.duocone(2,2,32,32);
	var dir = new Vec4(1,1,0,1).norm().cross(new Vec4(0,1));
	var s = Math.asin(dir.len());
	
	var diceM = Mesh4.spheritorus(1,2,8,8,16);
	//var diceM = Mesh4.tesseract(2).rotate(dir.mul(s/dir.len())).rotate(new Bivec(0,Math.PI/2));
	//var diceM = Mesh4.cuboid(0.5,2,0.5,0.5);
	//var diceM = Mesh4.cuboid(2,0.5,2,2);
	
	for(var c in diceM.C){
		if(!diceM.C[c].info) diceM.C[c].info = {};
		diceM.C[c].info.color = (Math.floor(c/32)%4<=1 ^ c%4<=1)?0xFFFF00:0xFF0000;
	}
	
	//R-E-U  B-F-B
	var dice = new Geom4(diceM,null,null,0xFF0000);
	var dice2 = new Geom4(diceM,null,null,0x0000FF);
	scene.add(dice);
	scene.add(dice2);

	var camera = new Camera4(80,0.01,50);
	camera.position = new Vec4(0,1,0,-5);
	
	var renderer = new MeshRenderer4(gl$("glCanvas"),scene,camera);
	
	var controler = new Controler4.KeepUp(renderer);
	controler.moveStep = 0.1;
	var gui = new dat.GUI();
	controler.addGUI(gui);
	
	physicsEngine = new Phy4d();
	physicsEngine.gravity = new Vec4(0,-0.1);
	var groundP = new Phy4d.Obj(new Phy4d.Plane(new Vec4(0,1,0,0),0),Infinity);
	var cameraP = new Phy4d.Obj(new Phy4d.Glome(camera.position,0.8),2);
	diceP = new Phy4d.Obj(new Phy4d.Spheritorus(new Vec4(0,3,0,0),1,2),0.4);
	var dice2P = new Phy4d.Obj(new Phy4d.Spheritorus(new Vec4(0.5,5,0,0),1,2),0.4);
	//diceP = new Phy4d.Obj(new Phy4d.Convex(diceM,new Vec4(0,3,0,0)),0.4);
	/*diceP.w.xy = -Math.random();
	diceP.w.yt = -Math.random();
	diceP.w.yz = -Math.random();
	diceP.w.zt = -Math.random();*/
	//var dice2P = new Phy4d.Obj(new Phy4d.Convex(diceM2,new Vec4(0,1,0.1,0)),1);
	//diceP.restitution = 0.0;
	//diceP.friction = 1.0;
	//physicsEngine.addObj(cameraP);
	physicsEngine.addObj(groundP);
	physicsEngine.addObj(diceP);
	physicsEngine.addObj(dice2P);
	//wall
	
	physicsEngine.addObj(new Phy4d.Obj(new Phy4d.Plane(new Vec4( 1,0,0,0),-planeWidth/2),Infinity));
	physicsEngine.addObj(new Phy4d.Obj(new Phy4d.Plane(new Vec4(-1,0,0,0),-planeWidth/2),Infinity));
	physicsEngine.addObj(new Phy4d.Obj(new Phy4d.Plane(new Vec4( 0,0, 1,0),-planeWidth/2),Infinity));
	physicsEngine.addObj(new Phy4d.Obj(new Phy4d.Plane(new Vec4( 0,0,-1,0),-planeWidth/2),Infinity));
	physicsEngine.addObj(new Phy4d.Obj(new Phy4d.Plane(new Vec4( 0,0,0, 1),-planeWidth/2),Infinity));
	physicsEngine.addObj(new Phy4d.Obj(new Phy4d.Plane(new Vec4( 0,0,0,-1),-planeWidth/2),Infinity));
	addGlome = function (x,y,z,t){
		var gP = new Phy4d.Obj(
			new Phy4d.Glome(
				new Vec4(x,y,z,t),
				1.3
			),
		1.2);
		
		var g = new Geom4(
			Mesh4.glome(gP.phyGeom.R,8,8,8), //shape
			null,//position
			null,
			Math.floor(0xFF0000)//color
		);
		g.boundingPhy4dObj = gP;
		scene.add(g);
		glomes.push(g);
		physicsEngine.addObj(gP);
	}
	glomes = [];
	function loop(){
		controler.update();
		var step = 5;
		physicsEngine.iterations = 10;
		physicsEngine.dt = Math.min(controler.dTime*0.001,0.1)/step;
		if(physicsEngine.pause!==true){
			while(step--)
				physicsEngine.next();
		}
		//Update position for display:
		dice.position = diceP.getPosition();
		dice.rotation = diceP.getRotation();
		dice2.position = dice2P.getPosition();
		dice2.rotation = dice2P.getRotation();
		for(var g of glomes){
			g.position = g.boundingPhy4dObj.getPosition();
			g.rotation = g.boundingPhy4dObj.getRotation();
		}
		renderer.render();
		window.requestAnimationFrame(loop);
	}
	loop();
	//addGlome(0,0.5,0,0);
	
	/*addContactHelper = function (contact){
		scene.add(new Geom4(Mesh4.glome(0.2,8,8,8),contact.p,null,0xFF0000));
		scene.add(new Geom4(Mesh4.spherinder(0.1,16,16,-contact.Vsep),contact.p,null,0xFF0000).lookAt(contact.p.add(contact.n,false)));
	}*/
	
}
</script>
<body onload="start()">
<canvas id="glCanvas" width="1600" height="800"></canvas>
</body>
</html>