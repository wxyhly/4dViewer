 <html>
<script src="../math.js"></script>
<script src="../shape.js"></script>
<script src="../webgl.js"></script>
<script src="../render.js"></script>
<script src="sun.js"></script>
<script src="minecraft4.js"></script>

<script src="dat.gui.min.js"></script>
<script src="controler.js"></script>
<script>
'use strict';
var gl$ = function (obj){
	return document.getElementById(obj).getContext("experimental-webgl");
}
var $ = function (obj){
	return document.getElementById(obj);
}
function start(){
	var scene = new Scene();
	var gnd = new Geom4(Mesh4.cuboid(50,2,50,50)).move(new Vec4(0,-1.5002,0,0));
	gnd.color = 0x666666;
	scene.add(gnd);
	var sun = new Geom4(Mesh3.sphere(50,10,10,10).embed(true)).move(new Vec4(0,500,0,0));
	sun.color = 0xFFFFFF;
	sun.glow = true;
	scene.add(sun);
	var terrain = new MCWorld(1);
	
	var focusMesh = Mesh4.cuboid(1,1,0.05,0.05).move(new Vec4(0,0,0.5,0.5));
	focusMesh.join(Mesh4.cuboid(1,1,0.05,0.05).move(new Vec4(0,0,0.5,-0.5)));
	focusMesh.join(Mesh4.cuboid(1,1,0.05,0.05).move(new Vec4(0,0,-0.5,-0.5)));
	focusMesh.join(Mesh4.cuboid(1,1,0.05,0.05).move(new Vec4(0,0,-0.5,0.5)));
	
	focusMesh.join(Mesh4.cuboid(1,0.05,0.05,1).move(new Vec4(0,0.5,0.5,0)));
	focusMesh.join(Mesh4.cuboid(1,0.05,0.05,1).move(new Vec4(0,0.5,-0.5,0)));
	focusMesh.join(Mesh4.cuboid(1,0.05,0.05,1).move(new Vec4(0,-0.5,-0.5,0)));
	focusMesh.join(Mesh4.cuboid(1,0.05,0.05,1).move(new Vec4(0,-0.5,0.5,0)));
	
	focusMesh.join(Mesh4.cuboid(0.05,0.05,1,1).move(new Vec4(0.5,0.5,0,0)));
	focusMesh.join(Mesh4.cuboid(0.05,0.05,1,1).move(new Vec4(0.5,-0.5,0,0)));
	focusMesh.join(Mesh4.cuboid(0.05,0.05,1,1).move(new Vec4(-0.5,-0.5,0,0)));
	focusMesh.join(Mesh4.cuboid(0.05,0.05,1,1).move(new Vec4(-0.5,0.5,0,0)));
	
	focusMesh.join(Mesh4.cuboid(0.05,1,0.05,1).move(new Vec4(0.5,0,0.5,0)));
	focusMesh.join(Mesh4.cuboid(0.05,1,0.05,1).move(new Vec4(0.5,0,-0.5,0)));
	focusMesh.join(Mesh4.cuboid(0.05,1,0.05,1).move(new Vec4(-0.5,0,-0.5,0)));
	focusMesh.join(Mesh4.cuboid(0.05,1,0.05,1).move(new Vec4(-0.5,0,0.5,0)));
	
	focusMesh.join(Mesh4.cuboid(0.05,1,1,0.05).move(new Vec4(0.5,0,0,0.5)));
	focusMesh.join(Mesh4.cuboid(0.05,1,1,0.05).move(new Vec4(0.5,0,0,-0.5)));
	focusMesh.join(Mesh4.cuboid(0.05,1,1,0.05).move(new Vec4(-0.5,0,0,-0.5)));
	focusMesh.join(Mesh4.cuboid(0.05,1,1,0.05).move(new Vec4(-0.5,0,0,0.5)));
	
	focusMesh.join(Mesh4.cuboid(1,0.05,1,0.05).move(new Vec4(0,0.5,0,0.5)));
	focusMesh.join(Mesh4.cuboid(1,0.05,1,0.05).move(new Vec4(0,0.5,0,-0.5)));
	focusMesh.join(Mesh4.cuboid(1,0.05,1,0.05).move(new Vec4(0,-0.5,0,-0.5)));
	focusMesh.join(Mesh4.cuboid(1,0.05,1,0.05).move(new Vec4(0,-0.5,0,0.5)));
	
	var focus = new Geom4(focusMesh);
	focus.color = 0xFF0000;
	focus.glow = true;
	scene.add(focus);
	
	var camera = new Camera4(90,0.01,550);
	camera.position = new Vec4(0,terrain.getTerrain_Y(0,0,0, 0,0,0)+5,0,0);
	var renderer = new Renderer4(gl$("glCanvas"),scene,camera,new Vec4(1.4,-4,1,2).norm());
	
	var controler = new Controler4.KeepUp(renderer,(pos)=>((pos.y>-0.5)?terrain.hitTest(pos):true));
	controler.gravity = true;
	controler.figure_height = 1.5; // used in hitTest
	controler.figure_width = 0.25; // used in hitTest
	controler.moveStep = 1;
	
	var laTerre = new Planet4();
	laTerre.location = {
		WE: 60, //latitude parallel to south
		MG: 120, //latitude parallel to north
		NS: 30 //longitude
	}
	laTerre.sun = {
		southernTropic: 12,
		northernTropic: 55,
		WEPeriod: 365.4, //southern days in one year
		MGPeriod: 123 //northern days in one year
	}
	laTerre.initialTime = {
		northernTime: 9,  //12h00
		southernTime: 9, //9h30
		season: 100 //sun orbit angle
	}
	var gui = new dat.GUI();
	controler.addGUI(gui);
	laTerre.addGUI(gui);
	var time = 0;
	laTerre.timeStep = 6;
	gui.add(laTerre,"timeStep",1,20);
	gui.add(camera.position,"x");
	gui.add(camera.position,"y");
	gui.add(camera.position,"z");
	gui.add(camera.position,"t");
	gui.add(MCWorld,"renderDistance", 2, 7);
	
	var focusPos = null;
	document.addEventListener('mousedown',function(ev){
		if(focusPos && !!document.pointerLockElement){
			if(ev.button == 0){
				console.log("removed");
				var p = focusPos.position;
				terrain.setBlockId(0, p.x, p.y, p.z, p.t);
			}else if(ev.button == 2){
				
				var p = focusPos.position;
				var id = 1;
				function _set(terrain,id,p,direction){
					switch(direction){
						case 5:
							terrain.setBlockId(id, p.x+1, p.y, p.z, p.t);
							break;
						case 4:
							terrain.setBlockId(id, p.x-1, p.y, p.z, p.t);
							break;
						case 1:
							terrain.setBlockId(id, p.x, p.y+1, p.z, p.t);
							break;               
						case 0:                  
							terrain.setBlockId(id, p.x, p.y-1, p.z, p.t);
							break;
						case 3:
							terrain.setBlockId(id, p.x, p.y, p.z+1, p.t);
							break;                    
						case 2:                       
							terrain.setBlockId(id, p.x, p.y, p.z-1, p.t);
							break;
						case 7:
							terrain.setBlockId(id, p.x, p.y, p.z, p.t+1);
							break;                         
						case 6:                            
							terrain.setBlockId(id, p.x, p.y, p.z, p.t-1);
							break;
							
					}
				}
				_set(terrain,id,p,focusPos.direction);
				if(!terrain.hitTest(camera.position)){
					console.log("placed"+focusPos.direction);
					terrainGeom.mesh = terrain.generateMesh();
					terrainGeom.mesh.update();
				}else{
					_set(terrain,0,p,focusPos.direction);
				}
			}
		}
	});
	var count = 0;
	function loop(){
		laTerre.setTime(time);
		laTerre.setSunAndRenderer(renderer,sun,500);
		time += Math.exp(-20+laTerre.timeStep);
		count++;
		if(count%4==0){
			scene.child[3] = terrain.generateGeom(camera.position.x,camera.position.z,camera.position.t);
			gnd.position.x = camera.position.x;
			gnd.position.z = camera.position.t;
			gnd.position.t = camera.position.z;
		}
		controler.update();
		focusPos = terrain.rayCast(camera.position, camera.rotation[0].mul(new Vec4(0,0,0,5),false).mul(camera.rotation[1]).add(camera.position));
		if(focusPos){
			focus.position = focusPos.position;
		}else{
			focus.position = new Vec4(0,-10,0,0);
		}
		
		renderer.render();
		window.requestAnimationFrame(loop);
	}
	loop();
}
</script>
<body onload="start()">
<canvas id="glCanvas" width="1600" height="800"></canvas>
</body>
</html>